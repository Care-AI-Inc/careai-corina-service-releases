name: Sign PowerShell scripts (SSL.com)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sign-ps1:
    runs-on: windows-latest

    # Avoid the bot's commit re-triggering itself
    if: github.actor != 'github-actions[bot]'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Import a code-signing certificate (PFX) from GitHub Secrets for Authenticode signing
      # Required secrets:
      # - CODESIGN_PFX_BASE64: base64-encoded PFX
      # - CODESIGN_PFX_PASSWORD: password for the PFX
      - name: Import code signing certificate (PFX)
        shell: pwsh
        env:
          CODESIGN_PFX_BASE64: ${{ secrets.CODESIGN_PFX_BASE64 }}
          CODESIGN_PFX_PASSWORD: ${{ secrets.CODESIGN_PFX_PASSWORD }}
        run: |
          if (-not $env:CODESIGN_PFX_BASE64)   { throw "Missing CODESIGN_PFX_BASE64 secret." }
          if (-not $env:CODESIGN_PFX_PASSWORD) { throw "Missing CODESIGN_PFX_PASSWORD secret." }
          $pfxPath = Join-Path $env:RUNNER_TEMP "codesign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:CODESIGN_PFX_BASE64))
          $secure = ConvertTo-SecureString -String $env:CODESIGN_PFX_PASSWORD -AsPlainText -Force
          $imported = Import-PfxCertificate -FilePath $pfxPath -CertStoreLocation Cert:\CurrentUser\My -Password $secure
          if (-not $imported) { throw "Failed to import PFX." }
          $thumb = ($imported | Select-Object -First 1).Thumbprint
          "IMPORTED_CERT_THUMBPRINT=$thumb" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Sign PowerShell scripts (Authenticode)
        shell: pwsh
        run: |
          $cert = Get-ChildItem Cert:\CurrentUser\My | Where-Object { $_.Thumbprint -eq $env:IMPORTED_CERT_THUMBPRINT -and $_.HasPrivateKey } | Select-Object -First 1
          if (-not $cert) { throw "Imported certificate not found in store or missing private key." }

          $files = @("daily-updater.ps1","install.ps1","uninstall.ps1")
          foreach ($f in $files) {
            $p = Join-Path $env:GITHUB_WORKSPACE $f
            if (-not (Test-Path $p)) { Write-Host "Skip missing file: $f"; continue }
            $sig = Set-AuthenticodeSignature -FilePath $p -Certificate $cert -TimestampServer "http://timestamp.digicert.com"
            Write-Host "$f -> $($sig.Status)"
            if ($sig.Status -ne 'Valid') {
              throw "Signing failed for $f: $($sig.Status) $($sig.StatusMessage)"
            }
          }

      - name: Verify Authenticode signatures
        shell: pwsh
        run: |
          $files = @("daily-updater.ps1","install.ps1","uninstall.ps1")
          $failed = @()
          foreach ($f in $files) {
            $p = Join-Path $env:GITHUB_WORKSPACE $f
            if (Test-Path $p) {
              $sig = Get-AuthenticodeSignature -FilePath $p
              Write-Host "$f -> $($sig.Status)"
              if ($sig.Status -ne 'Valid') { $failed += $f }
            }
          }
          if ($failed.Count -gt 0) { throw "Signature invalid for: $($failed -join ', ')" }

      - name: Commit signed scripts if changed
        shell: pwsh
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          $files = @("daily-updater.ps1","install.ps1","uninstall.ps1")
          $status = git status --porcelain -- $files
          if ($status) {
            git add -- $files
            git commit -m "chore(sign): sign PowerShell scripts [skip ci]"
            git push
          } else {
            Write-Host "No changes to commit."
          }

