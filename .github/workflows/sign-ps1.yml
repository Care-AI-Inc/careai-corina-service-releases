# name: Sign PowerShell scripts (SSL.com)

# on:
#   push:
#     branches: [ main ]
#   workflow_dispatch:

# permissions:
#   contents: write

# jobs:
#   sign-ps1:
#     runs-on: windows-latest

#     # Avoid the bot's commit re-triggering itself
#     if: github.actor != 'github-actions[bot]'

#     env:
#       INSTALL_DIR: C:\Users\runneradmin\eSignerCKA
#       MASTER_KEY_FILE: C:\Users\runneradmin\eSignerCKA\master.key

#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Download and Unzip eSignerCKA Setup
#         shell: pwsh
#         run: |
#           Invoke-WebRequest -OutFile eSigner_CKA_Setup.zip "https://github.com/SSLcom/eSignerCKA/releases/download/v1.0.6/SSL.COM-eSigner-CKA_1.0.6.zip"
#           Expand-Archive -Force eSigner_CKA_Setup.zip -DestinationPath "$env:RUNNER_TEMP\eSigner_CKA"
#           Remove-Item eSigner_CKA_Setup.zip
#           $exe = Get-ChildItem -Path "$env:RUNNER_TEMP\eSigner_CKA" -Recurse -Filter "*.exe" | Where-Object { $_.Name -like "*CKA*" } | Select-Object -First 1
#           if (-not $exe) { throw "eSigner CKA installer not found." }
#           Copy-Item -Path $exe.FullName -Destination "eSigner_CKA_Installer.exe"

#       - name: Setup eSignerCKA in Silent Mode
#         shell: pwsh
#         run: |
#           New-Item -ItemType Directory -Force -Path "${{ env.INSTALL_DIR }}" | Out-Null
#           ./eSigner_CKA_Installer.exe /CURRENTUSER /VERYSILENT /SUPPRESSMSGBOXES /DIR="${{ env.INSTALL_DIR }}" | Out-Null

#       - name: Configure eSignerCKA account
#         shell: pwsh
#         env:
#           MODE:        ${{ secrets.MODE }}
#           USERNAME:    ${{ secrets.USERNAME }}
#           PASSWORD:    ${{ secrets.PASSWORD }}
#           TOTP_SECRET: ${{ secrets.TOTP_SECRET }}
#         run: |
#           if (-not $env:MODE)        { throw "Missing secret: MODE (sandbox or product)" }
#           if (-not $env:USERNAME)    { throw "Missing secret: USERNAME" }
#           if (-not $env:PASSWORD)    { throw "Missing secret: PASSWORD" }
#           if (-not $env:TOTP_SECRET) { throw "Missing secret: TOTP_SECRET" }
#           & "${{ env.INSTALL_DIR }}/eSignerCKATool.exe" config -mode "$env:MODE" -user "$env:USERNAME" -pass "$env:PASSWORD" -totp "$env:TOTP_SECRET" -key "${{ env.MASTER_KEY_FILE }}" -r

#       - name: Load certificate into Windows certificate store
#         shell: pwsh
#         run: |
#           & "${{ env.INSTALL_DIR }}/eSignerCKATool.exe" unload
#           & "${{ env.INSTALL_DIR }}/eSignerCKATool.exe" load

#       - name: eSignerCKA status and provider info
#         shell: powershell
#         run: |
#           Write-Host "== eSignerCKA status =="
#           & "${{ env.INSTALL_DIR }}/eSignerCKATool.exe" status

#           Write-Host "== CertUtil store info (provider, keyspec) =="
#           certutil -user -store my $env:THUMBPRINT

#       - name: Select code signing certificate
#         shell: pwsh
#         run: |
#           $cert = Get-ChildItem Cert:\CurrentUser\My -CodeSigningCert | Sort-Object NotAfter -Descending | Select-Object -First 1
#           if (-not $cert) { throw "No code signing certificate found in CurrentUser\My after CKA load." }
#           "THUMBPRINT=$($cert.Thumbprint)" | Out-File -FilePath $env:GITHUB_ENV -Append

#       - name: Inspect certificate provider (no repair)
#         shell: powershell
#         run: |
#           certutil -user -store my $env:THUMBPRINT -v

#       - name: Sign PowerShell scripts (Authenticode via eSigner CKA, with timeout & retry)
#         shell: pwsh
#         run: |
#           $signScript = Join-Path $env:RUNNER_TEMP "sign-authenticode.ps1"
#           @'
#           param([Parameter(Mandatory=$true)][string]$thumb)
#           $ErrorActionPreference = 'Stop'
#           $cert  = Get-Item ("Cert:\CurrentUser\My\{0}" -f $thumb) -ErrorAction Stop
#           if (-not $cert -or -not $cert.HasPrivateKey) { throw "Certificate by THUMBPRINT not found or missing private key." }

#           $files = @("daily-updater.ps1","install.ps1","uninstall.ps1")
#           foreach ($f in $files) {
#             $p = Join-Path $env:GITHUB_WORKSPACE $f
#             if (-not (Test-Path $p)) { Write-Host "Skip missing file: $f"; continue }
#             try { Unblock-File -LiteralPath $p -ErrorAction SilentlyContinue } catch {}

#             $tsaList = @("http://ts.ssl.com","http://timestamp.digicert.com",$null)
#             $signed = $false
#             foreach ($tsa in $tsaList) {
#               $jobScript = {
#                 param($path,$thumbArg,$tsaUrl)
#                 $ErrorActionPreference = 'Stop'
#                 $certInner = Get-Item ("Cert:\CurrentUser\My\{0}" -f $thumbArg) -ErrorAction Stop
#                 if ($tsaUrl) {
#                   Set-AuthenticodeSignature -FilePath $path -Certificate $certInner -TimestampServer $tsaUrl -HashAlgorithm SHA256 -IncludeChain All -ErrorAction Stop
#                 } else {
#                   Set-AuthenticodeSignature -FilePath $path -Certificate $certInner -HashAlgorithm SHA256 -IncludeChain All -ErrorAction Stop
#                 }
#               }
#               $job = Start-Job -ScriptBlock $jobScript -ArgumentList $p,$thumb,$tsa
#               if (Wait-Job -Job $job -Timeout 240) {
#                 $sig = Receive-Job -Job $job -ErrorAction SilentlyContinue
#                 Remove-Job -Job $job -Force | Out-Null
#                 if ($sig -and $sig.Status -eq 'Valid') {
#                   $tsaName = $tsa; if (-not $tsaName) { $tsaName = 'no-timestamp' }
#                   Write-Host ("{0} -> {1} via {2}" -f $f, $sig.Status, $tsaName)
#                   $signed = $true
#                   break
#                 } else {
#                   $status = $null; $msg = $null
#                   if ($sig) { $status = $sig.Status; $msg = $sig.StatusMessage }
#                   $tsaName = $tsa; if (-not $tsaName) { $tsaName = 'no-timestamp' }
#                   Write-Warning ("Signing attempt failed for {0} via {1}: {2} {3}" -f $f, $tsaName, $status, $msg)
#                 }
#               } else {
#                 Stop-Job -Job $job -Force | Out-Null
#                 Remove-Job -Job $job -Force | Out-Null
#                 $tsaName = $tsa; if (-not $tsaName) { $tsaName = 'no-timestamp' }
#                 Write-Warning ("Signing attempt timed out for {0} via {1}" -f $f, $tsaName)
#               }
#             }
#             if (-not $signed) { throw ("Signing failed for {0}" -f $f) }
#           }
#           '@ | Set-Content -LiteralPath $signScript -Encoding UTF8

#           & pwsh -NoProfile -ExecutionPolicy Bypass -File $signScript -thumb $env:THUMBPRINT

#       - name: Verify Authenticode signatures
#         shell: pwsh
#         run: |
#           $files = @("daily-updater.ps1","install.ps1","uninstall.ps1")
#           $failed = @()
#           foreach ($f in $files) {
#             $p = Join-Path $env:GITHUB_WORKSPACE $f
#             if (Test-Path $p) {
#               $sig = Get-AuthenticodeSignature -FilePath $p
#               Write-Host "$f -> $($sig.Status)"
#               if ($sig.Status -ne 'Valid') { $failed += $f }
#             }
#           }
#           if ($failed.Count -gt 0) { throw "Signature invalid for: $($failed -join ', ')" }

#       - name: Upload eSignerCKA Logs
#         if: ${{ always() }}
#         uses: actions/upload-artifact@v4
#         with:
#           name: eSignerCKA-Logs
#           path: C:\Users\runneradmin\AppData\Roaming\eSignerCKA\KSP

#       - name: Commit signed scripts if changed
#         shell: pwsh
#         run: |
#           git config user.name  "github-actions[bot]"
#           git config user.email "github-actions[bot]@users.noreply.github.com"
#           $files = @("daily-updater.ps1","install.ps1","uninstall.ps1")
#           $status = git status --porcelain -- $files
#           if ($status) {
#             git add -- $files
#             git commit -m "chore(sign): sign PowerShell scripts [skip ci]"
#             git push
#           } else {
#             Write-Host "No changes to commit."
#           }

